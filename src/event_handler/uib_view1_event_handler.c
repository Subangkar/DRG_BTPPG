/*******************************************************************************
* This file was generated by UI Builder.
* User should hand edit this file.
********************************************************************************/

#include "app_main.h"
#include "view_data.h"
#include "uib_app_manager.h"
#include "uib_views.h"
#include "uib_views_inc.h"
#include "sensor_params.h"
#include <sensor.h>
#include <device/power.h>

#include <curl/curl.h>
#include <net_connection.h>

// --------------------------------------- External Functions ---------------------------------------
int uploadAllFiles(const char* dir);
// --------------------------------------------------------------------------------------------------

int is_running=0;
#define FONT_SIZE 20


#define SERVICE_APP_NAME "org.example.rawsensordata"

#define DATA_RECORDING_DURATION 10
#define DATA_RECORDING_INTERVAL 30

typedef struct appdata_t{
	char userid[31];
	uint16_t recording_duration;
	uint16_t recording_interval;
} appdata_t;

appdata_t appdata;

const char* get_lastModified(char *lastModified){
	char fpath[256];
	sprintf(fpath, "stat -c %%y %s%s/ | cut -f 2 -d ' ' | cut -f 1 -d '.'", app_get_data_path(), "current");
	FILE* fp = popen(fpath, "r");
	if(fp) {
		fscanf(fp, "%s", lastModified);
		pclose(fp);
		return lastModified;
	}
	return NULL;
}

const char* get_dataSize(char *fsize){
	char fpath[256];
	sprintf(fpath, "du -sh %s | cut -f 1", app_get_data_path());
	FILE* fp = popen(fpath, "r");
	if(fp) {
		fscanf(fp, "%s", fsize);
		pclose(fp);
		return fsize;
	}
	return NULL;
}

static void launch_service()
{
	dlog_print(DLOG_ERROR, LOG_TAG, ">>> launch_service called...");
	app_control_h app_control = NULL;
	if (app_control_create(&app_control)== APP_CONTROL_ERROR_NONE)
	{
		if ((app_control_set_app_id(app_control, SERVICE_APP_NAME) == APP_CONTROL_ERROR_NONE)
			&& (app_control_send_launch_request(app_control, NULL, &appdata) == APP_CONTROL_ERROR_NONE))
		{
			dlog_print(DLOG_INFO, LOG_TAG, "App launch request sent!");
		}
		else
		{
			dlog_print(DLOG_ERROR, LOG_TAG, "App launch request sending failed!");
		}
//		if (app_control_destroy(app_control) == APP_CONTROL_ERROR_NONE)
//		{
//			dlog_print(DLOG_INFO, LOG_TAG, "App control destroyed.");
//		}
		// We exit our launcher app, there is no point in keeping it open.
//		ui_app_exit();
	}
	else
	{
		dlog_print(DLOG_ERROR, LOG_TAG, "App control creation failed!");
	}
}

static void stop_service()
{
	dlog_print(DLOG_ERROR, LOG_TAG, ">>> stop_service called...");
	app_control_h app_control = NULL;
	if (app_control_create(&app_control)== APP_CONTROL_ERROR_NONE)
	{
		if ((app_control_set_app_id(app_control, SERVICE_APP_NAME) == APP_CONTROL_ERROR_NONE)
			&& (app_control_add_extra_data(app_control, "service_action", "stop") == APP_CONTROL_ERROR_NONE)
			&& (app_control_send_launch_request(app_control, NULL, &appdata) == APP_CONTROL_ERROR_NONE))
		{
			dlog_print(DLOG_INFO, LOG_TAG, "App launch request sent!");
		}
		else
		{
			dlog_print(DLOG_ERROR, LOG_TAG, "App launch request sending failed!");
		}
		if (app_control_destroy(app_control) == APP_CONTROL_ERROR_NONE)
		{
			dlog_print(DLOG_INFO, LOG_TAG, "App control destroyed.");
		}
//		ui_app_exit();
	}
	else
	{
		dlog_print(DLOG_ERROR, LOG_TAG, "App control creation failed!");
	}
}


char last_modified[256];
char fsize[20];
Eina_Bool update_fileSize_info(void *user_data){
	char formatted_label[256];
	sprintf(formatted_label, "<font=Tizen:style=Regular font_size=%d>DataSize = %s </font/>", FONT_SIZE, get_dataSize(fsize));
	elm_object_text_set(((uib_view1_view_context*)user_data)->file_size, formatted_label);

	sprintf(formatted_label, "<font=Tizen:style=Regular font_size=%d>%s </font/>", 15, get_lastModified(last_modified));
	elm_object_text_set(((uib_view1_view_context*)user_data)->activity, formatted_label);
	return ECORE_CALLBACK_RENEW;
}

Ecore_Timer* upload_timer=NULL;
Eina_Bool upload_data(void *user_data){
	uploadAllFiles(app_get_data_path());
    dlog_print(DLOG_WARN, LOG_TAG, ">>> upload done...");
    upload_timer=NULL;
    return ECORE_CALLBACK_CANCEL;
}

Ecore_Timer* timer = NULL;
void start_onclicked(uib_view1_view_context *vc, Evas_Object *obj, void *event_info) {
	strncpy(appdata.userid, "subangkar", 31);
	appdata.recording_duration=DATA_RECORDING_DURATION;
	appdata.recording_interval=DATA_RECORDING_INTERVAL;
	launch_service();
	if(!timer)
		timer = ecore_timer_loop_add(5, update_fileSize_info, vc);
	else
		ecore_timer_thaw(timer);
	is_running=1;
}

void stop_onclicked(uib_view1_view_context *vc, Evas_Object *obj, void *event_info){
	stop_service();
	if(timer){
		ecore_timer_freeze(timer);
		ecore_timer_reset(timer);
	}
	is_running=0;
}

void upload_onclicked(uib_view1_view_context *vc, Evas_Object *obj, void *event_info){
//	int was_running=is_running;
//	if(was_running){
//		stop_service();
//		if(timer){
//			ecore_timer_freeze(timer);
//			ecore_timer_reset(timer);
//		}
//	}
    dlog_print(DLOG_WARN, LOG_TAG, ">>> upload_onclicked...");
	if(!upload_timer)
		upload_timer = ecore_timer_loop_add(2, upload_data, vc);
	else
		ecore_timer_thaw(upload_timer);
//	uploadAllFiles(app_get_data_path());
//	start_onclicked(vc, obj, event_info);
//    if(was_running){
//		launch_service();
//		if(!timer)
//			timer = ecore_timer_loop_add(5, update_fileSize_info, vc);
//		else
//			ecore_timer_thaw(timer);
//		is_running=1;
//    }
}

